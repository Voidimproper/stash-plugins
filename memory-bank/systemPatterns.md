# System Patterns

## Architecture Overview

### Repository Structure Pattern

```
stash-plugins/
├── plugins/                    # Plugin collection
│   ├── __init__.py            # Package marker
│   ├── PluginName/            # Individual plugin directory
│   │   ├── __init__.py        # Plugin package marker
│   │   ├── plugin_name.py     # Main implementation
│   │   ├── plugin_name.yml    # Plugin metadata/config
│   │   ├── requirements.txt   # Plugin dependencies
│   │   └── README.md          # Plugin documentation
│   └── void_common/           # Shared utilities
├── memory-bank/               # Cline documentation
├── notebooks/                 # Development notebooks
├── scripts/                   # Build/utility scripts
└── build artifacts            # Generated by build_site.sh
```

### Plugin Architecture Pattern

Each plugin follows a consistent structure:

- **Metadata**: YAML configuration with settings, tasks, and execution details
- **Implementation**: Python module with StashInterface integration
- **Dependencies**: Isolated requirements.txt for plugin-specific needs
- **Documentation**: README with usage and configuration instructions

### Build System Pattern

```
build_site.sh → _site/
├── index.yml              # Plugin source index
└── PluginName.zip         # Plugin distribution packages
```

## Key Technical Decisions

### 1. Multi-Plugin Repository Approach

- **Decision**: Support multiple plugins in single repository
- **Rationale**: Enables shared utilities, consistent tooling, easier maintenance
- **Implementation**: Individual plugin directories with isolated dependencies

### 2. GitHub Pages Deployment

- **Decision**: Use GitHub Pages for plugin distribution
- **Rationale**: Free hosting, automatic HTTPS, direct integration with GitHub
- **Implementation**: `build_site.sh` generates static site with plugin index

### 3. Plugin Source Index Format

- **Decision**: Generate YAML index compatible with Stash Plugin Manager
- **Rationale**: Seamless integration with official plugin installation flow
- **Implementation**: Automated generation with checksums and metadata

### 4. Python 3.12+ Focus

- **Decision**: Target Python 3.12+ exclusively (updated from multi-version)
- **Rationale**: Simplify development, leverage latest features, match modern Stash environments
- **Implementation**: pyproject.toml specifies requires-python = ">=3.12"

### 5. Quality Assurance Integration

- **Decision**: Mandatory code quality checks via pre-commit and CI
- **Rationale**: Maintain consistency, prevent runtime errors, follow community standards
- **Implementation**: Black, Flake8, MyPy, isort with specific configurations

## Design Patterns in Use

### 1. Template Repository Pattern

- Clone-and-modify approach for new plugin repositories
- Pre-configured tooling reduces setup friction
- Standardized structure promotes consistency

### 2. Plugin Isolation Pattern

- Each plugin maintains its own dependencies
- Shared utilities in `void_common` package
- Individual configuration and documentation

### 3. Automated Pipeline Pattern

```
Code Change → Pre-commit Hooks → CI Tests → Build → Deploy
```

### 4. Configuration-as-Code Pattern

- Plugin behavior defined in YAML files
- Settings exposed through Stash UI
- Tasks defined declaratively with execution parameters

## Component Relationships

### Plugin-to-Stash Communication

```
Plugin Code → StashInterface → Stash GraphQL API → Stash Database
```

### Build Process Flow

```
Plugin Source → build_site.sh → ZIP + Index → GitHub Pages → Plugin Manager
```

### Development Workflow

```
Local Development → Pre-commit → Push → CI/CD → Deployment
```

## Critical Implementation Paths

### 1. Plugin Execution Flow

1. Stash loads plugin via Plugin Manager
2. Plugin configuration read from YAML
3. Task execution triggers Python script
4. StashInterface handles API communication
5. Results returned to Stash UI

### 2. Build and Deployment Flow

1. Developer commits plugin changes
2. GitHub Actions triggers on push to main/develop
3. Quality checks run (tests, linting, formatting)
4. `build_site.sh` generates plugin packages and index
5. Artifacts deployed to GitHub Pages
6. Plugin Manager can discover and install updates

### 3. Development Setup Flow

1. Clone repository
2. `pip install -e ".[dev]"` installs development dependencies
3. `make install-hooks` configures pre-commit
4. VS Code workspace provides IDE integration
5. Local testing via Stash development instance

## GalleryLinker Pattern Examples

### Plugin Configuration Pattern

```yaml
# YAML-driven configuration
name: Gallery Linker
settings:
  autoLinkByDate:
    type: BOOLEAN
  dateTolerance:
    type: NUMBER
tasks:
  - name: Auto-Link Galleries to Scenes
    defaultArgs:
      mode: auto_link_scenes
```

### Task-Based Execution Pattern

- Multiple tasks per plugin (auto_link_scenes, auto_link_performers, generate_report)
- Mode-based execution with different behaviors
- Debug tracing and dry-run modes for safe operation

### UI Integration Pattern

- JavaScript UI components (`gallery_linker.js`)
- Settings exposed through Stash plugin interface
- Real-time feedback and progress reporting

## Community Plugin Repositories (Reference Examples)

These remote repositories provide excellent examples of different plugin architectures, patterns, and implementation approaches:

- **7dJx1qP/stash-plugins**: https://github.com/7dJx1qP/stash-plugins
- **MinasukiHikimuna/MidnightRider-Stash**: https://github.com/MinasukiHikimuna/MidnightRider-Stash
- **S3L3CT3DLoves/stashPlugins**: https://github.com/S3L3CT3DLoves/stashPlugins
- **Serechops/Serechops-Stash**: https://github.com/Serechops/Serechops-Stash
- **Valkyr-JS Plugin Collection** (extensive JavaScript-focused plugins):
  - **PerformerDetailsExtended**: https://github.com/Valkyr-JS/PerformerDetailsExtended
  - **StashMergers**: https://github.com/Valkyr-JS/StashMergers
  - **StashReels**: https://github.com/Valkyr-JS/StashReels
  - **ValkyrSceneCards**: https://github.com/Valkyr-JS/ValkyrSceneCards
  - **stash-plugins**: https://github.com/Valkyr-JS/stash-plugins
- **W0lfieW0lf/StashApp-Tools**: https://github.com/W0lfieW0lf/StashApp-Tools
- **carrotwaxr/stash-plugins**: https://github.com/carrotwaxr/stash-plugins
- **d0t-d0t-d0t/stash-repo**: https://github.com/d0t-d0t-d0t/stash-repo
- **feederbox826/stashlist**: https://github.com/feederbox826/stashlist
- **rosa-umineko/CommunityScripts**: https://github.com/rosa-umineko/CommunityScripts
- **stg-annon/StashScripts**: https://github.com/stg-annon/StashScripts
- **tetrax-10/stash-stuffs**: https://github.com/tetrax-10/stash-stuffs
- **xiosensei/Xio-Stash**: https://github.com/xiosensei/Xio-Stash

These repositories demonstrate various approaches to:
- Plugin architecture and organization
- JavaScript UI integration patterns
- Python backend implementations
- Configuration management strategies
- Community distribution methods
